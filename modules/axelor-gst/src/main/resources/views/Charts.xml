<?xml version="1.0" encoding="UTF-8"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://axelor.com/xml/ns/object-views
  http://axelor.com/xml/ns/object-views/object-views_5.0.xsd">


	<chart name="invoice-chart-bar" title="Unpaid Invoices per Customer"
		onInit="action-record-set-default-date-time">
		<search-fields>
			<field type="datetime" name="fromDateTime" title="From Date"
				expr="eval: __datetime__.minusMonths(1)" />
			<field type="datetime" name="toDateTime" title="To Date"
				expr="eval: __datetime__" />
		</search-fields>
		<dataset type="jpql"> 
  <![CDATA[
 SELECT p.name as customer,Count(i.id) as invoices 
 FROM Invoice i,Party p 
 WHERE i.status != '3' 
 AND p.isCustomer ='t' 
 AND i.dateTime 
 BETWEEN :fromDateTime AND :toDateTime  group by p.name
  ]]>
  </dataset>
		<category key="customer" type="text" title="Customer" />
		<series key="invoices" type="bar" title="Unpaid Invoices" />
	</chart>


	<chart name="customer-chart-pie" title="Customer per State">

		<dataset type="sql"> 
  <![CDATA[
 select gst_state.name as state,Count(gst_party.id) as customers from gst_party,gst_state where gst_party.is_customer='t' group by gst_state.name;
  ]]>
  </dataset>
		<category key="state" type="text" title="State" />
		<series key="customers" type="pie" title="Customers" />
	</chart>


	<custom name="invoice-custom-table" title="Invoices Older than One Month"
		css="report-table">
		<field name="status" />
		<field name="company" />
		<field name="reference" />
		<field name="dateTime" />
		<field name="useInvoiceAddress" />
		<field name="netAmount" />
		<field name="netIGST" />
		<field name="netCGST" />
		<field name="netSGST" />
		<field name="grossAmount" />
		<dataset type="sql">
  <![CDATA[
    select status as status, company as company, reference as reference, date_time as datetime, gross_amount as grossAmount
    from gst_invoice 
    where date_time <= current_timestamp - interval'30 days' AND status=2;
  ]]>
  </dataset>
		<template>
  <![CDATA[
 <report-table data='data' columns='status,company,reference,datetime,grossAmount'></report-table>  
  </div>
  ]]>
  </template>
	</custom>


	<chart name="invoice-status-chart-bar" title="Amount per Status">
		<dataset type="sql"> 
  <![CDATA[
 select status as status,sum(gross_amount) as amount from gst_invoice group by status;
  ]]>
  </dataset>
		<category key="status" type="text" title="Status" />
		<series key="amount" type="bar" title="Total Gross Amount" />
	</chart>


	<chart name="invoice-status-count-chart-line" title="Total Invoices per Status">

		<dataset type="sql"> 
  <![CDATA[
 select status as status,count(id) invoice from gst_invoice group by status;
  ]]>
  </dataset>
		<category key="status" type="text" title="Status" />
		<series key="invoice" type="line" title="Invoice Count" />
	</chart>



	<chart name="invoice-category-product-chart-bar" title="Paid Invoices per Product" onInit="action-record-set-default-date-time">
		<search-fields>
			<field type="datetime" name="fromDateTime" title="From Date" />
			<field type="datetime" name="toDateTime" title="To Date" />
		</search-fields>
		<dataset type="jpql"> 
  <![CDATA[
  
  SELECT p.name as product,COUNT(i.id) as invoices FROM Invoice i
  INNER JOIN InvoiceLine l ON i.id = l.invoice
  INNER JOIN Product p ON l.product=p.id 
  WHERE i.status=3 
  AND (i.dateTime BETWEEN :fromDateTime AND :toDateTime) 
  GROUP BY p.name
 
  ]]>
  </dataset>
		<category key="product" type="text" title="Product" />
		<series key="invoices" type="bar" title="Paid Invoices" />
	</chart>

	<action-record model="com.axelor.gst.db.Invoice"
		name="action-record-set-default-date-time">
		<field name="toDateTime" expr="eval:__datetime__" />
		<field name="fromDateTime" expr="eval:__datetime__.minusMonths(1)" />
	</action-record>
</object-views>